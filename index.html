<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Biblioteca con Supabase</title>
    <style>
        /* CSS Mínimo y Necesario */
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4; /* Fondo muy claro */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinear arriba */
            min-height: 90vh; /* Ocupar casi toda la altura visible */
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 900px; /* Ancho máximo aumentado para más columnas */
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #555;
            margin-bottom: 20px;
        }
        h2 {
            color: #666;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            text-align: left; /* Alinear el título de la sección a la izquierda */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .loading-message {
            background-color: #e0f7fa;
            color: #007bb6;
        }
        .error-message {
            background-color: #ffe0b2;
            color: #e65100;
        }
        .hidden {
            display: none;
        }
        .query-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .query-button {
            background-color: #4CAF50; /* Verde */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .query-button:hover {
            background-color: #45a049;
        }
        
        /* Estilos para el apartado de inserción de datos */
        .insert-section {
            margin-top: 30px;
            border-top: 2px solid #ddd;
            padding-top: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .form-container {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        
        .form-container.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .submit-btn:hover {
            background-color: #45a049;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
    </style>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js'

        // Configura tus credenciales de Supabase
        // ¡IMPORTANTE! REEMPLAZA ESTOS VALORES CON LOS DE TU PROYECTO SUPABASE
        const SUPABASE_URL = 'https://qedriadefuijndgbhcxg.supabase.co'; // Ejemplo: 'https://abcdefghijk.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlZHJpYWRlZnVpam5kZ2JoY3hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NTA0MDUsImV4cCI6MjA2NTQyNjQwNX0.IXdIfUqlOrQWQttRArPl_bnYWVWKd5hjiow6IqunA0g'; // Ejemplo: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'


        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /**
         * Muestra un mensaje de estado (carga o error).
         * @param {string} type - 'loading' o 'error'.
         * @param {string} message - El texto del mensaje.
         */
        function showStatusMessage(type, message) {
            const loading = document.getElementById('loadingMessage');
            const error = document.getElementById('errorMessage');

            loading.classList.add('hidden');
            error.classList.add('hidden');

            if (type === 'loading') {
                loading.textContent = message;
                loading.classList.remove('hidden');
            } else if (type === 'error') {
                error.textContent = message;
                error.classList.remove('hidden');
            }
        }

        /**
         * Oculta todos los mensajes de estado.
         */
        function hideStatusMessages() {
            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        /**
         * Carga y muestra los datos de una consulta específica en la tabla de resultados.
         * @param {string} queryType - El tipo de consulta a ejecutar.
         */
        async function loadQueryData(queryType) {
            const table = document.getElementById('resultsTable');
            const tableHead = table.querySelector('thead');
            const tableBody = table.querySelector('tbody');
            const queryTitle = document.getElementById('currentQueryTitle');

            tableHead.innerHTML = ''; // Limpiar encabezados
            tableBody.innerHTML = ''; // Limpiar cuerpo de la tabla
            table.classList.add('hidden'); // Ocultar tabla mientras carga

            showStatusMessage('loading', 'Cargando datos...');

            try {
                let data, error;
                let headers = [];
                let rowMapper; // Función para mapear un objeto de datos a una fila de tabla

                switch (queryType) {
                    case 'prestamos_detallados':
                        queryTitle.textContent = 'Consulta: Préstamos Detallados';
                        ({ data, error } = await supabase
                            .from('esprestado') // Tabla 'esprestado' del nuevo diagrama
                            .select(`
                                id_lector,
                                id_libro,
                                fecha_presta,
                                lector (nombre, email),
                                libro (titulo, anio)
                            `));
                        headers = ['ID Lector', 'ID Libro', 'Fecha Préstamo', 'Nombre Lector', 'Email Lector', 'Título Libro', 'Año Libro'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.id_lector;
                            row.insertCell().textContent = item.id_libro;
                            row.insertCell().textContent = new Date(item.fecha_presta).toLocaleDateString('es-ES');
                            row.insertCell().textContent = item.lector ? item.lector.nombre : 'Desconocido';
                            row.insertCell().textContent = item.lector ? item.lector.email : 'N/A';
                            row.insertCell().textContent = item.libro ? item.libro.titulo : 'Desconocido';
                            row.insertCell().textContent = item.libro ? item.libro.anio : 'N/A';
                        };
                        break;
                    case 'lectores':
                        queryTitle.textContent = 'Consulta: Todos los Lectores';
                        ({ data, error } = await supabase
                            .from('lector') // Tabla 'lector' del nuevo diagrama
                            .select(`
                                id_lector,
                                nombre,
                                email
                            `));
                        headers = ['ID Lector', 'Nombre', 'Email'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.id_lector;
                            row.insertCell().textContent = item.nombre;
                            row.insertCell().textContent = item.email;
                        };
                        break;
                    case 'libros':
                        queryTitle.textContent = 'Consulta: Todos los Libros';
                        ({ data, error } = await supabase
                            .from('libro') // Tabla 'libro' del nuevo diagrama
                            .select(`
                                id_libro,
                                titulo,
                                anio
                            `));
                        headers = ['ID Libro', 'Título', 'Año'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.id_libro;
                            row.insertCell().textContent = item.titulo;
                            row.insertCell().textContent = item.anio;
                        };
                        break;
                    case 'libros_disponibles':
                        queryTitle.textContent = 'Consulta: Libros Disponibles (No Prestados)';
                        ({ data, error } = await supabase
                            .from('libro')
                            .select(`
                                id_libro,
                                titulo,
                                anio,
                                esprestado(id_lector)
                            `)
                            .is('esprestado.id_lector', null)); // Filtra los libros que no tienen un préstamo asociado

                        headers = ['ID Libro', 'Título', 'Año'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.id_libro;
                            row.insertCell().textContent = item.titulo;
                            row.insertCell().textContent = item.anio;
                        };
                        break;
                    case 'prestamos_ordenados_fecha':
                        queryTitle.textContent = 'Consulta: Préstamos Ordenados por Fecha';
                        ({ data, error } = await supabase
                            .from('esprestado')
                            .select(`
                                id_lector,
                                id_libro,
                                fecha_presta,
                                lector (nombre),
                                libro (titulo)
                            `)
                            .order('fecha_presta', { ascending: false })); // Ordena por fecha de forma descendente

                        headers = ['ID Lector', 'Nombre Lector', 'ID Libro', 'Título Libro', 'Fecha Préstamo'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.id_lector;
                            row.insertCell().textContent = item.lector ? item.lector.nombre : 'Desconocido';
                            row.insertCell().textContent = item.id_libro;
                            row.insertCell().textContent = item.libro ? item.libro.titulo : 'Desconocido';
                            row.insertCell().textContent = new Date(item.fecha_presta).toLocaleDateString('es-ES');
                        };
                        break;
                    case 'lectores_ambos_libros':
                        queryTitle.textContent = 'Consulta: Lectores que pidieron prestado tanto "Rayuela" como "Ficciones"';
                        
                        // Primero obtenemos los IDs de los libros "Rayuela" y "Ficciones"
                        let { data: librosData, error: librosError } = await supabase
                            .from('libro')
                            .select('id_libro, titulo')
                            .in('titulo', ['Rayuela', 'Ficciones']);
                            
                        if (librosError) throw librosError;
                        
                        // Extraer los IDs de los libros
                        const rayuelaId = librosData.find(libro => libro.titulo === 'Rayuela')?.id_libro;
                        const ficcionesId = librosData.find(libro => libro.titulo === 'Ficciones')?.id_libro;
                        
                        if (!rayuelaId || !ficcionesId) {
                            // Si no se encuentran los libros, devuelve un array vacío
                            data = [];
                            break;
                        }
                        
                        // Obtenemos todos los préstamos de estos dos libros
                        let { data: prestamosData, error: prestamosError } = await supabase
                            .from('esprestado')
                            .select(`
                                id_lector,
                                id_libro,
                                lector (id_lector, nombre)
                            `)
                            .in('id_libro', [rayuelaId, ficcionesId]);
                            
                        if (prestamosError) throw prestamosError;
                        
                        // Agrupar por lector para encontrar quiénes han prestado ambos libros
                        const lectoresPorLibro = {};
                        prestamosData.forEach(prestamo => {
                            const idLector = prestamo.id_lector;
                            if (!lectoresPorLibro[idLector]) {
                                lectoresPorLibro[idLector] = {
                                    nombre: prestamo.lector?.nombre,
                                    libros: new Set()
                                };
                            }
                            lectoresPorLibro[idLector].libros.add(prestamo.id_libro);
                        });
                        
                        // Filtrar lectores que tienen ambos libros
                        const lectoresConAmbosLibros = Object.values(lectoresPorLibro)
                            .filter(lector => lector.libros.size === 2 && 
                                              lector.libros.has(rayuelaId) && 
                                              lector.libros.has(ficcionesId))
                            .map(lector => ({ nombre: lector.nombre }));
                            
                        data = lectoresConAmbosLibros;
                        
                        headers = ['Nombre del Lector'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.nombre;
                        };
                        break;
                    case 'libros_presta_recientes':
                        queryTitle.textContent = 'Consulta: Libros prestados después del 1 de junio de 2025';
                        ({ data, error } = await supabase
                            .from('esprestado')
                            .select(`
                                id_libro,
                                fecha_presta,
                                libro (titulo)
                            `)
                            .gt('fecha_presta', '2025-06-01'));
                        
                        headers = ['Título', 'Fecha de Préstamo'];
                        rowMapper = (row, item) => {
                            row.insertCell().textContent = item.libro ? item.libro.titulo : 'Desconocido';
                            row.insertCell().textContent = new Date(item.fecha_presta).toLocaleDateString('es-ES');
                        };
                        break;
                    default:
                        throw new Error('Tipo de consulta no reconocido.');
                }

                if (error) throw error;

                // Crear encabezados de la tabla
                const headerRow = tableHead.insertRow();
                headers.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });

                if (data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align: center;">No hay datos para esta consulta.</td></tr>`;
                } else {
                    data.forEach(item => {
                        rowMapper(tableBody.insertRow(), item); // Usar la función de mapeo para rellenar la fila
                    });
                }
                table.classList.remove('hidden'); // Mostrar tabla
            } catch (error) {
                console.error('Error al ejecutar consulta:', error.message);
                showStatusMessage('error', `Error al ejecutar consulta: ${error.message}.`);
            } finally {
                if (document.getElementById('errorMessage').classList.contains('hidden')) {
                    hideStatusMessages();
                }
            }
        }

        // Cargar los datos de la consulta inicial al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            loadQueryData('prestamos_detallados'); // Cargar la consulta detallada por defecto

            // Asignar eventos a los botones de consulta
            document.getElementById('btnPrestamosDetallados').addEventListener('click', () => loadQueryData('prestamos_detallados'));
            document.getElementById('btnLectores').addEventListener('click', () => loadQueryData('lectores'));
            document.getElementById('btnLibros').addEventListener('click', () => loadQueryData('libros'));
            document.getElementById('btnLibrosDisponibles').addEventListener('click', () => loadQueryData('libros_disponibles'));
            document.getElementById('btnPrestamosOrdenados').addEventListener('click', () => loadQueryData('prestamos_ordenados_fecha'));
            document.getElementById('btnLectoresAmbosLibros').addEventListener('click', () => loadQueryData('lectores_ambos_libros'));
            document.getElementById('btnLibrosPrestaRecientes').addEventListener('click', () => loadQueryData('libros_presta_recientes'));
            
            // Configuración para los formularios de inserción
            setupTabs();
            setupFormHandlers();
            loadSelectOptions();
            setupDefaultDate();
        });
        
        /**
         * Configura la navegación por pestañas en la sección de inserción
         */
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Resetear clases activas
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.form-container').forEach(form => form.classList.remove('active'));
                    
                    // Activar pestaña y formulario seleccionados
                    tab.classList.add('active');
                    const formId = tab.getAttribute('data-form');
                    document.getElementById(formId).classList.add('active');
                });
            });
        }
        
        /**
         * Configura la fecha actual por defecto en el campo de fecha de préstamo
         */
        function setupDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            
            document.getElementById('prestamoFecha').value = `${yyyy}-${mm}-${dd}`;
        }
        
        /**
         * Carga las opciones para los selects de lectores y libros
         */
        async function loadSelectOptions() {
            try {
                // Cargar lectores para el select de préstamos
                const { data: lectores, error: errorLectores } = await supabase
                    .from('lector')
                    .select('id_lector, nombre');
                
                if (errorLectores) throw errorLectores;
                
                const lectorSelect = document.getElementById('prestamoLector');
                lectorSelect.innerHTML = '<option value="">Seleccione un lector</option>';
                
                lectores.forEach(lector => {
                    const option = document.createElement('option');
                    option.value = lector.id_lector;
                    option.textContent = lector.nombre;
                    lectorSelect.appendChild(option);
                });
                
                // Cargar libros disponibles para el select de préstamos
                const { data: libros, error: errorLibros } = await supabase
                    .from('libro')
                    .select('id_libro, titulo');
                
                if (errorLibros) throw errorLibros;
                
                const libroSelect = document.getElementById('prestamoLibro');
                libroSelect.innerHTML = '<option value="">Seleccione un libro</option>';
                
                libros.forEach(libro => {
                    const option = document.createElement('option');
                    option.value = libro.id_libro;
                    option.textContent = libro.titulo;
                    libroSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error al cargar opciones:', error);
                showStatusMessage('error', `Error al cargar opciones para los formularios: ${error.message}`);
            }
        }
        
        /**
         * Configura los manejadores de eventos para los formularios de inserción
         */
        function setupFormHandlers() {
            // Formulario de Libro
            document.getElementById('insertLibroForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    showStatusMessage('loading', 'Guardando libro...');
                    
                    const titulo = document.getElementById('libroTitulo').value.trim();
                    const anio = parseInt(document.getElementById('libroAnio').value);
                    
                    const { data, error } = await supabase
                        .from('libro')
                        .insert([{ titulo, anio }])
                        .select();
                    
                    if (error) throw error;
                    
                    showSuccessMessage('¡Libro guardado correctamente!');
                    document.getElementById('insertLibroForm').reset();
                    loadQueryData('libros'); // Actualizar la tabla si estamos viendo libros
                    loadSelectOptions(); // Actualizar las opciones de los selects
                    
                } catch (error) {
                    console.error('Error al insertar libro:', error);
                    showStatusMessage('error', `Error al guardar el libro: ${error.message}`);
                } finally {
                    hideStatusMessages();
                }
            });
            
            // Formulario de Lector
            document.getElementById('insertLectorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    showStatusMessage('loading', 'Guardando lector...');
                    
                    const nombre = document.getElementById('lectorNombre').value.trim();
                    const email = document.getElementById('lectorEmail').value.trim();
                    
                    const { data, error } = await supabase
                        .from('lector')
                        .insert([{ nombre, email }])
                        .select();
                    
                    if (error) throw error;
                    
                    showSuccessMessage('¡Lector guardado correctamente!');
                    document.getElementById('insertLectorForm').reset();
                    loadQueryData('lectores'); // Actualizar la tabla si estamos viendo lectores
                    loadSelectOptions(); // Actualizar las opciones de los selects
                    
                } catch (error) {
                    console.error('Error al insertar lector:', error);
                    showStatusMessage('error', `Error al guardar el lector: ${error.message}`);
                } finally {
                    hideStatusMessages();
                }
            });
            
            // Formulario de Préstamo
            document.getElementById('insertPrestamoForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    showStatusMessage('loading', 'Registrando préstamo...');
                    
                    const id_lector = document.getElementById('prestamoLector').value;
                    const id_libro = document.getElementById('prestamoLibro').value;
                    const fecha_presta = document.getElementById('prestamoFecha').value;
                    
                    // Verificar si el libro ya está prestado
                    const { data: prestadoData, error: prestadoError } = await supabase
                        .from('esprestado')
                        .select('*')
                        .eq('id_libro', id_libro);
                    
                    if (prestadoError) throw prestadoError;
                    
                    if (prestadoData && prestadoData.length > 0) {
                        throw new Error('Este libro ya está prestado actualmente.');
                    }
                    
                    const { data, error } = await supabase
                        .from('esprestado')
                        .insert([{ id_lector, id_libro, fecha_presta }])
                        .select();
                    
                    if (error) throw error;
                    
                    showSuccessMessage('¡Préstamo registrado correctamente!');
                    document.getElementById('insertPrestamoForm').reset();
                    setupDefaultDate(); // Resetear la fecha al valor por defecto
                    loadQueryData('prestamos_detallados'); // Actualizar la tabla de préstamos
                    
                } catch (error) {
                    console.error('Error al registrar préstamo:', error);
                    showStatusMessage('error', `Error al registrar el préstamo: ${error.message}`);
                } finally {
                    hideStatusMessages();
                }
            });
        }
        
        /**
         * Muestra un mensaje de éxito
         * @param {string} message - El texto del mensaje
         */
        function showSuccessMessage(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            
            // Ocultar el mensaje después de 3 segundos
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Gestión de Biblioteca</h1>

        <div id="loadingMessage" class="message loading-message hidden"></div>
        <div id="errorMessage" class="message error-message hidden"></div>

        <h2 id="currentQueryTitle">Consulta de Préstamos Detallados</h2>
        <div class="query-buttons">
            <button class="query-button" id="btnPrestamosDetallados">Préstamos Detallados</button>
            <button class="query-button" id="btnLectores">Todos los Lectores</button>
            <button class="query-button" id="btnLibros">Todos los Libros</button>
            <button class="query-button" id="btnLibrosDisponibles">Libros Disponibles</button>
            <button class="query-button" id="btnPrestamosOrdenados">Préstamos por Fecha</button>
            <button class="query-button" id="btnLectoresAmbosLibros">Lectores de Rayuela y Ficciones</button>
            <button class="query-button" id="btnLibrosPrestaRecientes">Libros después del 1/Jun/2025</button>
        </div>

        <table id="resultsTable">
            <thead></thead>
            <tbody></tbody>
        </table>

        <!-- Sección para inserción de datos -->
        <div class="insert-section">
            <h2>Inserción de Datos</h2>
            <div id="successMessage" class="success-message"></div>
            
            <div class="tabs">
                <div class="tab active" data-form="libroForm">Insertar Libro</div>
                <div class="tab" data-form="lectorForm">Insertar Lector</div>
                <div class="tab" data-form="prestamoForm">Registrar Préstamo</div>
            </div>
            
            <!-- Formulario para insertar un libro -->
            <div id="libroForm" class="form-container active">
                <form id="insertLibroForm">
                    <div class="form-group">
                        <label for="libroTitulo">Título:</label>
                        <input type="text" id="libroTitulo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="libroAnio">Año de publicación:</label>
                        <input type="number" id="libroAnio" class="form-control" required>
                    </div>
                    <button type="submit" class="submit-btn">Guardar Libro</button>
                </form>
            </div>
            
            <!-- Formulario para insertar un lector -->
            <div id="lectorForm" class="form-container">
                <form id="insertLectorForm">
                    <div class="form-group">
                        <label for="lectorNombre">Nombre:</label>
                        <input type="text" id="lectorNombre" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="lectorEmail">Email:</label>
                        <input type="email" id="lectorEmail" class="form-control" required>
                    </div>
                    <button type="submit" class="submit-btn">Guardar Lector</button>
                </form>
            </div>
            
            <!-- Formulario para registrar un préstamo -->
            <div id="prestamoForm" class="form-container">
                <form id="insertPrestamoForm">
                    <div class="form-group">
                        <label for="prestamoLector">Lector:</label>
                        <select id="prestamoLector" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="prestamoLibro">Libro:</label>
                        <select id="prestamoLibro" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="prestamoFecha">Fecha de Préstamo:</label>
                        <input type="date" id="prestamoFecha" class="form-control" required>
                    </div>
                    <button type="submit" class="submit-btn">Registrar Préstamo</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Cambiar entre las pestañas de inserción
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const target = this.dataset.form;

                // Activar la pestaña actual
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Mostrar el formulario correspondiente
                document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
                document.getElementById(target).classList.add('active');
            });
        });

        // Insertar un libro
        document.getElementById('insertLibroForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const titulo = document.getElementById('libroTitulo').value;
            const anio = document.getElementById('libroAnio').value;

            if (!titulo || !anio) {
                return alert('Por favor, complete todos los campos.');
            }

            try {
                const { data, error } = await supabase
                    .from('libro')
                    .insert([{ titulo: titulo, anio: anio }]);

                if (error) throw error;

                document.getElementById('successMessage').textContent = 'Libro insertado con éxito.';
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);

                // Limpiar campos
                document.getElementById('libroTitulo').value = '';
                document.getElementById('libroAnio').value = '';
            } catch (error) {
                console.error('Error al insertar libro:', error.message);
                alert('Error al insertar libro: ' + error.message);
            }
        });

        // Insertar un lector
        document.getElementById('insertLectorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nombre = document.getElementById('lectorNombre').value;
            const email = document.getElementById('lectorEmail').value;

            if (!nombre || !email) {
                return alert('Por favor, complete todos los campos.');
            }

            try {
                const { data, error } = await supabase
                    .from('lector')
                    .insert([{ nombre: nombre, email: email }]);

                if (error) throw error;

                document.getElementById('successMessage').textContent = 'Lector insertado con éxito.';
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);

                // Limpiar campos
                document.getElementById('lectorNombre').value = '';
                document.getElementById('lectorEmail').value = '';
            } catch (error) {
                console.error('Error al insertar lector:', error.message);
                alert('Error al insertar lector: ' + error.message);
            }
        });

        // Registrar un préstamo
        document.getElementById('insertPrestamoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const idLector = document.getElementById('prestamoLector').value;
            const idLibro = document.getElementById('prestamoLibro').value;
            const fechaPresta = document.getElementById('prestamoFecha').value;

            if (!idLector || !idLibro || !fechaPresta) {
                return alert('Por favor, complete todos los campos.');
            }

            try {
                const { data, error } = await supabase
                    .from('esprestado')
                    .insert([{ id_lector: idLector, id_libro: idLibro, fecha_presta: fechaPresta }]);

                if (error) throw error;

                document.getElementById('successMessage').textContent = 'Préstamo registrado con éxito.';
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);

                // Limpiar campos
                document.getElementById('prestamoLector').value = '';
                document.getElementById('prestamoLibro').value = '';
                document.getElementById('prestamoFecha').value = '';
            } catch (error) {
                console.error('Error al registrar préstamo:', error.message);
                alert('Error al registrar préstamo: ' + error.message);
            }
        });

        // Cargar lectores y libros en los formularios de préstamo
        async function loadLectorsAndBooks() {
            try {
                // Cargar lectores
                let { data: lectores, error: lectoresError } = await supabase
                    .from('lector')
                    .select('id_lector, nombre');

                if (lectoresError) throw lectoresError;

                const lectorSelect = document.getElementById('prestamoLector');
                lectorSelect.innerHTML = ''; // Limpiar opciones existentes
                lectores.forEach(lector => {
                    const option = document.createElement('option');
                    option.value = lector.id_lector;
                    option.textContent = lector.nombre;
                    lectorSelect.appendChild(option);
                });

                // Cargar libros
                let { data: libros, error: librosError } = await supabase
                    .from('libro')
                    .select('id_libro, titulo');

                if (librosError) throw librosError;

                const libroSelect = document.getElementById('prestamoLibro');
                libroSelect.innerHTML = ''; // Limpiar opciones existentes
                libros.forEach(libro => {
                    const option = document.createElement('option');
                    option.value = libro.id_libro;
                    option.textContent = libro.titulo;
                    libroSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar lectores o libros:', error.message);
            }
        }

        // Llamar a la función para cargar lectores y libros al inicio
        loadLectorsAndBooks();
    </script>
</body>
</html>

